<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CH341 test webusb</title>
</head>


<body>
  <button id="connect">Connect</button>
  <button id="disconnect">disConnect</button>
  <label for="editor">TX</label><textarea id="editor">Flash Easy</textarea>
  <button id="submit">Send</button>
  <label for="output">RX</label><textarea id="output"></textarea>
</body>
<script type="module">
  import { CH341 } from "./src/lib/CH341.js"
  import { SPI } from "./src/lib/SPI.js"
  import { UART } from "./src/lib/UART.js"
  import { I2C } from "./src/lib/I2C.js"
  import { PCA9685 } from "./src/PCA9685.js"
  import { VL531L1X } from "./src/VL531L1X.js"
  import { TB6600 } from "./src/TB6600.js"
  import { AS5600 } from "./src/AS5600.js"
  import { ADS1115 } from "./src/ADS1115.js"
  const ch341 = new CH341()
  document.querySelector("#connect").onclick = async () => {

    const device = await CH341.requestDevice()
    /*await ch341.open(device)
    const tb6600 = new TB6600(ch341)
    tb6600.MotorMove(5,false)*/
    //await ch341.SetupPin(CH341.D0, false)
    // await ch341.SetupPin(CH341.D0, true)
    //const r = await ch341.GetPinsStatus()
    //console.log(r)
    /*await ch341.SetupPin(CH341.D1, false, false)
    await ch341.SetupPin(CH341.D2, false, false)
    const r = await ch341.GetPinsStatus()
    console.log(r)*/


    //await spi.startRx((result) => console.log(result))
    // await spi.SpiStream(tx)
    //const r = await spi.ReadStatus()
    //console.log(r)
    //const serial = new UART()
    //const AS5600Addr= 0x36
    const ads1115Addr = 0x48
    const i2c = new I2C()
    //const device = await CH341.requestDevice()
    await i2c.open(device)
    let found_count = 0;
    for (let i = I2C.I2C_AddressMin; i <= I2C.I2C_AddressMax; ++i)
      if (await i2c.I2CDetect(i))
        console.log(`Found i2c slave device at address 0x${i.toString(16)}`);
    i2c.setAddr(ads1115Addr)
    const ads1115 = new ADS1115(i2c)
    ads1115.setGain(ADS1115.REG_CONFIG_PGA_6_144V)
    await ads1115.configSingle()
    const data = await ads1115.readData()
    console.log(data)
    /*i2c.setAddr(AS5600Addr)
    const AS5600Y = new AS5600(i2c)
    const startPos = await AS5600Y.getStatus()
    console.log(startPos)
    const angle = await AS5600Y.getAngle()
    console.log(angle)
    const endPos = await AS5600Y.getEndPos()
    console.log(endPos)*/
    /*const addr = 0x40
    i2c.setAddr(addr)
    const pca = new PCA9685(i2c)
    await pca.setPWMFreq(1000);
    //for (let i = 20; i < 40; i += 5) {
      //await pca.setServoAngle(0, i);
      await pca.analogWrite(0, 0)
      await i2c.wait(30);
    //}
    */
    /* const vl531l1x = new VL531L1X(i2c)
     i2c.setAddr(0x29)
     const res = await vl531l1x.GetSensorId()
     console.log(res)
     while (!(await vl531l1x.BootState())) {
       await i2c.wait(1000);
       console.log('Wait for device boot - retry')
     }
     await vl531l1x.SensorInit()
     console.log('sensor init')
     const polarity = await vl531l1x.GetInterruptPolarity()
     console.log(polarity)*/
    //  console.log(`Scan complete, ${found_count} found.`);
  }

  document.querySelector("#disconnect").onclick = async () => {
    await ch341.exit()
  }

  document.querySelector("#submit").onclick = async () => {
    // await serial.startTx("TEST")
    await ch341.wait(50)
    const r1 = await ch341.GetPinsStatus()
    console.log(r1)
  }
</script>

</html>